FROM mcr.microsoft.com/azure-functions/python:4-python3.9-appservice

ARG DOCKER_AZURITE_ACCOUNT_NAME
ENV DOCKER_AZURITE_ACCOUNT_NAME=${DOCKER_AZURITE_ACCOUNT_NAME}
ARG DOCKER_AZURITE_ACCOUNT_KEY
ENV DOCKER_AZURITE_ACCOUNT_KEY=${DOCKER_AZURITE_ACCOUNT_KEY}
ARG DOCKER_AZURITE_BLOB_PORT
ENV DOCKER_AZURITE_BLOB_PORT=${DOCKER_AZURITE_BLOB_PORT}
ARG DOCKER_AZURITE_QUEUE_PORT
ENV DOCKER_AZURITE_QUEUE_PORT=${DOCKER_AZURITE_QUEUE_PORT}
ARG DOCKER_AZURITE_TABLE_PORT
ENV DOCKER_AZURITE_TABLE_PORT=${DOCKER_AZURITE_TABLE_PORT}
ARG DOCKER_AZFNS_PORT
ENV DOCKER_AZFNS_PORT=${DOCKER_AZFNS_PORT}

ENV AzureWebJobsScriptRoot=/home/site/wwwroot
ENV AzureFunctionsJobHost__Logging__Console__IsEnabled=true
ENV AzureWebJobsStorage=DefaultEndpointsProtocol=http;AccountName=${DOCKER_AZURITE_ACCOUNT_NAME};AccountKey=${DOCKER_AZURITE_ACCOUNT_KEY};BlobEndpoint=http://azurite:${DOCKER_AZURITE_BLOB_PORT}/${DOCKER_AZURITE_ACCOUNT_NAME};QueueEndpoint=http://azurite:${DOCKER_AZURITE_QUEUE_PORT}/${DOCKER_AZURITE_ACCOUNT_NAME};TableEndpoint=http://azurite:${DOCKER_AZURITE_TABLE_PORT}/${DOCKER_AZURITE_ACCOUNT_NAME};
ENV FUNCTIONS_WORKER_RUNTIME=python
ENV WEBSITE_HOSTNAME=localhost:${DOCKER_AZFNS_PORT}
ENV ENABLE_ORYX_BUILD=false
ENV SCM_DO_BUILD_DURING_DEPLOYMENT=true
ENV WEBSITE_RUN_FROM_PACKAGE=0


ADD ./function_apps /home/site/wwwroot
RUN cd /home/site/wwwroot && pip install ./dist/*.whl